<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">

<link>

    <meta charset="UTF-8">
    <title>CreatePage</title>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyC_4-Dhm35VlOSAcoRktC8dMIC8y8oSuYA",
            authDomain: "comicsqueeze.firebaseapp.com",
            databaseURL: "https://comicsqueeze.firebaseio.com",
            projectId: "comicsqueeze",
            storageBucket: "comicsqueeze.appspot.com",
            messagingSenderId: "213405157042"
        };
        firebase.initializeApp(config);
    </script>
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src =js/signIn.js></script>
    <script src = js/uploadData.js></script>
    <script src = js/download.js></script>
    <link href="css/page_layout.css" rel="stylesheet">
    <link href="css/buttons.css" rel="stylesheet">
    <link href="css/register_main_styles.css" rel="stylesheet">
    <link href="../css/literallycanvas.css" rel="stylesheet">

    <!-- dependency: React.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-with-addons.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>

    <!-- Literally Canvas -->
    <script src="js/literallycanvas.js"></script>

    <style type="text/css">
        .fs-container {
            /*width: 663px;*/
            height: 900px;
            margin: auto;
        }
    </style>

</head>

<body style="margin: 0px">

<div class="flexContainer flexColumn fullHeight whiteBackground">
    <nav class="navBar darkGreyBackground">
        <a style="float: left; padding-left: 17%; display: inline-block">
            <img th:if="${session.username}!=null" th:src="${curMember.getImgUrl()}" class="navUserIcon" style="border-radius: 50%;">
            <a th:if="${session.username}!=null" th:href="@{/yourprofile}" th:text="${session.username}" class="navButton" style="float: left; margin-left: 15px; display: inline-block"></a>
            <a th:if="${session.username}!=null" href="#notifications-modal-container" data-reveal-id="exampleModal" class="navButton" style="float: left; display: inline-block">
                <img src="images/icons/notification_icon.png" th:src="@{/images/icons/notification_icon.png}" class="navIcon">
            </a>
        </a>
        <a th:href="@{/}" class="navLogo"></a>
        <div style="float: right; padding-right: 17%;">
            <a th:href="@{/search}" style="float: right; display: inline-block">
                <img src="images/icons/search_icon.png" th:src="@{/images/icons/search_icon.png}" class="navIcon">
            </a>
            <a th:if="${session.username}==null" th:href="@{/register}" class="navButton" style="float: right; margin-right: 10px">REGISTER</a>
            <a th:if="${session.username}==null" href="#signIn-modal-container" data-reveal-id="signIn-modal" class="navButton" style="float: right;">SIGN IN</a>
            <a th:if="${session.username}!=null" class="button-as-link" style="width: fit-content; margin: 0 10px 0 0; float: right;">
                <button class="navButton" id="signOut" style="border-bottom: 0; border-top: 0" onclick="signOut()">LOG OUT</button>
            </a>
        </div>
    </nav>

    <div class="flexContainer flexItem">

        <main class="flexItem whiteBackground main">
            <h1>Create Page</h1>

            <!--<iframe src="https://www.photopea.com?rnd=167753414#%7B%22files%22:%5B%22https://www.photopea.com/api/img/pug.png%22%5D,%22environment%22:%7B%7D%7D"-->
                    <!--id="pp" style="border:none; width:100%; height:900px;"></iframe>-->

            <div class="fs-container">
                <div id="lc" style="height: 900px; border: 1px solid black"></div>
            </div>

            <script type="text/javascript">
                // getting current series and issue that the user is under in heirarchy
                var username = "[[${session.curMember.getUsername()}]]"
                var currentSeries = "[[${session.curMember.getCurrentSeries().getTitle()}]]"
                var currentIssue = "[[${session.curMember.getCurrentIssue().getTitle()}]]"

                var lc = LC.init(document.getElementById("lc"), {
                    imageURLPrefix: 'images/img',
                    toolbarPosition: 'bottom',
                    defaultStrokeWidth: 2,
                    strokeWidths: [1, 2, 3, 5, 30],
                    imageSize: {width: 700, height: 950},
                    backgroundColor: 'white',
                    tools: [LC.tools.Pencil, LC.tools.Eraser, LC.tools.Line, LC.tools.Rectangle, LC.tools.Ellipse, LC.tools.Text,
                        LC.tools.Polygon, LC.tools.Pan, LC.tools.Eyedropper, LC.tools.SelectShape]
                });
                var localStorageKey = 'drawing';
                if (localStorage.getItem(localStorageKey)) {
                    lc.loadSnapshot(JSON.parse(localStorage.getItem(localStorageKey)));
                }
                lc.on('drawingChange', function() {
                    localStorage.setItem(localStorageKey, JSON.stringify(lc.getSnapshot()));
                });

                function returnJSON() {
                    var pagedata = JSON.stringify(lc.getSnapshot());
                    //upload this data to fire base under the current data heirarchy and user id
                    uploadJSONtoFirebase(currentSeries,currentIssue,1,pagedata);

                };

                // gets PNG of drawing (tied to button in form below)
                function exportPNG() {
                    console.log("export png");
                    // window.open(lc.getImage().toDataURL());
                    download(lc.getImage().toDataURL(), "comic_page.png", "image/png");
                    // var pagePNG = lc.getImage();
                };

                function passLoadValues() {
                    // just for testing
                    loadImage(lc.getImage().toDataURL(), "myImg");
                }
                function loadImage(img_b64, elemID) {
                    var png = img_b64.split(',')[1];

                    var the_file = new Blob([window.atob(png)],  {type: 'image/png', encoding: 'utf-8'});


                    var fr = new FileReader();
                    fr.onload = function ( oFREvent ) {
                        var v = oFREvent.target.result.split(',')[1]; // encoding is messed up here, so we fix it
                        v = atob(v);
                        var good_b64 = btoa(decodeURIComponent(escape(v)));
                        var img = "data:image/png;base64," + good_b64;
                        uploadPagetoDB(username,currentSeries,currentIssue,1,img);

                        document.getElementById(elemID).src = "data:image/png;base64," + good_b64;

                    };
                    fr.readAsDataURL(the_file);
                }
            </script>

            <a class="button-as-link" style="width: fit-content; margin: 0">
                <button class="grey-button-left" onclick="exportPNG()">Export as PNG</button>
            </a>
            <!--<img id="myImg" style="height: 200px; width: 80px; object-fit: cover">-->
            <!--<a class="button-as-link" style="width: fit-content; margin: 0">-->
                <!--<button class="grey-button-left" onclick="passLoadValues()">TEST</button>-->
            <!--</a>-->

            <div class="flexContainer flexRow" style="justify-content: space-between; margin-top: 10px">
                <a class="button-as-link" style="width: fit-content; margin: 0">
                    <button class="lime-button-left" onclick="passLoadValues()">SAVE</button>
                </a>
                <a th:href="@{/}" class="button-as-link close-reveal-modal" style="width: fit-content; margin: 0">
                    <button class="grey-button-left">CANCEL</button>
                </a>
            </div>

            <br><br>

        </main>

        <aside class="sidebar sidebarLeft" style="width: 5%"></aside>
        <aside class="sidebar sidebarRight" style="width: 5%"></aside>

    </div>

    <footer class="footer darkGreyBackground">Copyright &copy; Debugging Enterprises</footer>

</div>

</body>

</html>